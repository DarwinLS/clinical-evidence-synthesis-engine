<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Evidence Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=3">
</head>
<body>

    <main class="container">
        
        <header>
            <h1>Clinical Data Synth</h1>
            <p class="subtitle">PubMed-verified synthesis without the hallucinations.</p>
        </header>
        
        <section class="search-card">
            <form action="/analyze" method="post" class="search-form" onsubmit="document.getElementById('loader').style.display='block'">
    
                <div class="form-row-main">
                    <input type="text" name="supplement" placeholder="Enter Supplement (e.g. Creatine Monohydrate)" required value="{{ search_term or '' }}">
                </div>
                
                <div class="form-row-secondary">
                    <input type="number" name="age" placeholder="Age" required min="1" max="120" value="{{ search_age or '' }}">
                    
                    <select name="goal">
                        <option value="general" {% if search_goal == 'general' %}selected{% endif %}>General Health</option>
                        <option value="strength" {% if search_goal == 'strength' %}selected{% endif %}>Strength & Hypertrophy</option>
                        <option value="cognition" {% if search_goal == 'cognition' %}selected{% endif %}>Brain & Cognition</option>
                        <option value="sleep" {% if search_goal == 'sleep' %}selected{% endif %}>Sleep Quality</option>
                    </select>

                    <button type="submit" class="btn-primary">Generate Report</button>
                </div>

            </form>

            <div id="loader" style="display:none; text-align:center; margin-top:20px; color: var(--secondary);">
                <small>Analyzing PubMed studies... this may take 20-30 seconds.</small>
            </div>

            {% if error %}
            <div class="error-box">
                <strong>Analysis Failed:</strong> {{ error }}
            </div>
            {% endif %}
        </section>

        {% if result %}
        <article class="report-container">
            
            <div class="report-header">
                <div class="report-title">
                    <h2>{{ result.supplement }}</h2>
                </div>
                <div class="badges">
                    <span class="badge">Age: {{ search_age }}</span>
                    <span class="badge">Goal: {{ search_goal|capitalize }}</span>
                </div>
            </div>
            
            <div class="evidence-section">
                {% for section in result.summary %}
    
                {% set t = section.topic|lower %}
                {% set border_class = 'border-blue' %} 
                
                {% if 'effic' in t or 'benefit' in t %}
                    {% set border_class = 'border-green' %}
                {% elif 'dos' in t or 'usage' in t or 'admin' in t %}
                    {% set border_class = 'border-purple' %}
                {% elif 'side' in t or 'risk' in t or 'safe' in t or 'adverse' in t %}
                    {% set border_class = 'border-red' %}
                {% endif %}

                <article class="card {{ border_class }}">
                    <h3>
                        {% if border_class == 'border-green' %} <span>üìà</span>
                        {% elif border_class == 'border-purple' %} <span>üíä</span>
                        {% elif border_class == 'border-red' %} <span>‚ö†Ô∏è</span>
                        {% else %} <span>üìã</span>
                        {% endif %}
                        
                        {{ section.topic }}
                    </h3>
                    
                    <div class="card-text">
                        {{ section.text }}
                        {% for id in section.citation_ids %}
                            <a href="#ref-{{ citation_map[id] }}" class="cite-ref" title="Go to Reference">
                                {{ citation_map[id] }}
                            </a>
                        {% endfor %}
                    </div>
                </article>
                {% endfor %}
            </div>

            {% if bibliography %}
            <section class="references-container">
                <h3>References & Clinical Data</h3>
                <ol class="ref-list">
                    {% for study in bibliography %}
                    <li id="ref-{{ loop.index }}" class="ref-item">
                        <span class="ref-title">{{ study.title }}</span>
                        <div class="ref-meta">
                            <span><strong>{{ study.journal }}</strong> ({{ study.year }})</span>
                            <span>Type: {{ study.study_type }}</span>
                            <span>n={{ study.n }}</span>
                            <a href="https://pubmed.ncbi.nlm.nih.gov/{{ study.id }}/" target="_blank" class="pubmed-link">
                                PubMed {{ study.id }} ‚Üó
                            </a>
                        </div>
                    </li>
                    {% endfor %}
                </ol>
            </section>
            {% endif %}

        </article>
        {% endif %}

    </main>
    
    <div id="disclaimer-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Prototype Disclaimer</h2>
            </div>
            <div class="modal-body">
                <p><strong>This is an experimental MVP.</strong></p>
                <p>This tool uses Artificial Intelligence to synthesize clinical data. It may produce hallucinations, incorrect citations, or incomplete summaries.</p>
                <ul>
                    <li>Do not use this for medical advice.</li>
                    <li>Always verify citations on PubMed.</li>
                    <li>The extracted data has not been manually verified by a human.</li>
                </ul>
            </div>
            <button id="accept-btn" class="modal-btn">I Understand & Agree</button>
        </div>
    </div>
    
    <script src="/static/script.js"></script>
</body>
</html>